<!DOCTYPE html>
<html>
<style>
    #loading {
        visibility: hidden;
        position: fixed;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        text-align: center;
        opacity: 0.7;
        background-color: #fff;
        z-index: 99;
    }

    #loading-image {
        position: relative;
    }
</style>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link href="/static/css/project_config_styles.css" rel="stylesheet">
</head>

<body>
    <div id="loading">
        <img id="loading-image" src="/static/images/loader.gif">
    </div>
    <div class="modal fade" id="configuration-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
        aria-hidden="true">
        <div id="modal-body" class="modal-body" style="margin-top:200px;"></div>
    </div>
    <div class="modal fade" id="device-selection-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div>
            <select id="device-dropdown" name="devices" onchange="enableDisableSubmit(this)">
            </select>
            <button id="add-device-button" type="button" onclick="registerIOSDevice()">Add device</button>
        </div>
    </div>
    <div class="topnav">
        <link href="/static/css/top_navigation_style.css" rel="stylesheet">
        <a href="/">Home</a>
        <a class="active" href="configuration">Project configuration</a>
        <a href="iOSContainers">iOS containers</a>
        <a href="androidContainers">Android containers</a>
    </div>
    <div>
        <table id="configurationInfoTable">
            <link href="/static/css/config_table.css" rel="stylesheet">
            <tr>
                <th>Devices Host
                    <div class="tooltip">?
                        <span class="tooltiptext">The address of the host machine</span>
                    </div>
                </th>
                <th>Selenium Hub Host
                    <div class="tooltip">?
                        <span class="tooltiptext">The address of the targetted Selenium Hub. Not used if you won't
                            connect
                            to Selenium Hub.</span>
                    </div>
                </th>
                <th>Selenium Hub Port
                    <div class="tooltip">?
                        <span class="tooltiptext">The port of the targetted Selenium Hub. Not used if you won't connect
                            to
                            Selenium Hub.</span>
                    </div>
                </th>
                <th>Selenium Hub Protocol Type
                    <div class="tooltip">?
                        <span class="tooltiptext">The protocol type of the targetted Selenium Hub. Not used if you won't
                            connect to Selenium Hub.</span>
                    </div>
                </th>
                <th>WDA Bundle ID
                    <div class="tooltip">?
                        <span class="tooltiptext">The bundle ID of the targetted WDA application.</span>
                    </div>
                </th>
            </tr>
            <tr>
                <td>{{.DevicesHost}}</td>
                <td>{{.SeleniumHubHost}}</td>
                <td>{{.SeleniumHubPort}}</td>
                <td>{{.SeleniumHubProtocolType}}</td>
                <td>{{.WdaBundleID}}</td>
            </tr>
        </table>
    </div>
    <div class="config-buttons">
        <button class="config-button" id="config-button" type="button" onclick="showConfigModal()">Change project
            config</button>
        <button class="config-button" id="config-button" type="button" onclick="notImplemented()">Edit
            Dockerfile</button>
        <button class="config-button" id="config-button" type="button" onclick="buildImage(this)">Build Docker
            image</button>
        <button class="config-button" id="config-button" type="button" onclick="removeImage()">Remove Docker
            image</button>
        <button class="config-button" id="config-button" type="button" onclick="startListener(true)">Start listener -
            Grid</button>
        <button class="config-button" id="config-button" type="button" onclick="startListener(false)">Start listener -
            No Grid</button>
        <button class="config-button" id="config-button" type="button" onclick="stopListener()">Stop listener</button>
        <button class="config-button" id="config-button" type="button" onclick="showIOSDeviceSelection()">Add a
            device</button>
        <button class="config-button" id="config-button" type="button" onclick="notImplemented()">Setup udev listener</button>
        <button class="config-button" id="config-button" type="button" onclick="notImplemented()">Remove udev listener</button>
    </div>
    <script>
        /* Show info modal with provided text */
        function showConfigModal() {
            /* Get the modal element */
            var modal = document.getElementById("configuration-modal")

            /* Get the close button */
            var span = document.getElementsByClassName("close")[0]

            $("#modal-body").load("/static/project_config_submission_form.html");

            /* Display the modal blocking interaction */
            modal.style.display = "block";

            /* Close the modal if you click anywhere outside the modal */
            window.onclick = function (event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
        };

        function showDockerfileModal() {
            /* Get the modal element */
            var modal = document.getElementById("configuration-modal")

            /* Get the close button */
            var span = document.getElementsByClassName("close")[0]

            $("#modal-body").load("/static/edit_file_modal.html");

            /* Display the modal blocking interaction */
            modal.style.display = "block";

            /* Close the modal if you click anywhere outside the modal */
            window.onclick = function (event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
        }

        function buildImage(obj) {
            /* Show loading indicator until response is returned */
            $('#loading').css("visibility", "visible");

            /* Call the endpoint that will restart the selected container */
            var req = $.ajax({
                timeout: 120000,
                async: false,
                type: "GET",
                url: "/build-image",
                success: function (data) {
                    alert("Successfully created image tagged: test \n" + data)
                    /* Hide the loading after response is returned */
                    $('#loading').css("visibility", "hidden");
                },
                error: function (data) {
                    alert(JSON.stringify(data))
                    $('#loading').css("visibility", "hidden");
                }
            });
        }

        function removeImage() {
            /* Show loading indicator until response is returned */
            $('#loading').css("visibility", "visible");

            /* Call the endpoint that will restart the selected container */
            $.ajax({
                dataType: false,
                async: true,
                type: "GET",
                url: "/remove-image",
                success: function (data) {
                    alert(data)
                },
                error: function (data) {
                    alert(JSON.stringify(data))
                }
            });

            /* Hide the loading after response is returned */
            $('#loading').css("visibility", "hidden");
        }

        function stopListener() {
            /* Show loading indicator until response is returned */
            $('#loading').css("visibility", "visible");

            /* Call the endpoint that will restart the selected container */
            $.ajax({
                dataType: false,
                async: true,
                type: "GET",
                url: "/stop-listener",
                success: function (data) {
                    alert(data)
                },
                error: function (data) {
                    alert(JSON.stringify(data))
                }
            });

            /* Hide the loading after response is returned */
            $('#loading').css("visibility", "hidden");
        }

        function startListener(gridBool) {
            /* Show loading indicator until response is returned */
            $('#loading').css("visibility", "visible");

            if (gridBool) {
                url = "/start-listener-grid"
            } else {
                url = "/start-listener-no-grid"
            }

            /* Call the endpoint that will start the respective listener config */
            $.ajax({
                dataType: false,
                async: true,
                type: "GET",
                url: url,
                success: function (data) {
                    alert(data)
                },
                error: function (data) {
                    alert(JSON.stringify(data))
                }
            });

            /* Hide the loading after response is returned */
            $('#loading').css("visibility", "hidden");
        }

        function showIOSDeviceSelection() {
            $('#add-device-button').prop('disabled', true);
            /* Get the modal element */
            var modal = document.getElementById("device-selection-modal")

            /* Get the close button */
            var span = document.getElementsByClassName("close")[0]

            let dropdown = $('#device-dropdown');

            dropdown.empty();

            dropdown.append('<option>Choose device</option>');
            dropdown.prop('selectedIndex', 0);

            $.ajax({
                dataType: false,
                async: true,
                type: "GET",
                url: "/get-ios-devices",
                success: function (data) {
                    var response = JSON.parse(data)
                    for (let i = 0; i < response.deviceList.length; i++) {
                        dropdown.append($('<option></option>').attr('value', response.deviceList[i].Udid).text("Device UDID: " + response.deviceList[i].Udid + ", Product Type: " + response.deviceList[i].ProductType + ", Device OS: " + response.deviceList[i].ProductVersion));
                    }
                },
                error: function (data) {
                    alert("Couldn't get devices")
                }
            });

            /* Display the modal blocking interaction */
            modal.style.display = "block";

            /* Close the modal if you click anywhere outside the modal */
            window.onclick = function (event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
        }

        function registerIOSDevice() {
            var modal = document.getElementById("device-selection-modal")
            // Get the device UDID from the value of the selected option
            var device_udid = $("#device-dropdown").val();

            // Send a request to register the device with the respective selected device UDID
            $.ajax({
                dataType: false,
                async: true,
                type: "GET",
                url: "/register-ios-device/" + device_udid,
                success: function (data) {
                    alert(data)
                    modal.style.display = "none";
                },
                error: function (data) {
                    alert(data)
                    modal.style.display = "none";
                }
            });
        }

        function enableDisableSubmit(dropdownObj) {
            // Check the currently selected option
            // If it is the default one disable the Add button else enable it
            if (dropdownObj.options[dropdownObj.selectedIndex].text === "Choose device") {
                $('#add-device-button').prop('disabled', true);
            } else {
                $('#add-device-button').prop('disabled', false);
            }
        }

        function notImplemented() {
            alert("Not implemented")
        }
    </script>
</body>

</html>